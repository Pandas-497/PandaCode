<!DOCTYPE html>
<head>
    <title>PandaCode</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="favicon.png">
    <meta charset="utf-8">
    <meta name="author" content="Team Pandas">
    <meta name="description" content="Learn web programming!">
    <meta property="og:type" content="website">
    <meta property="og:title" content="PandaCode">
    <meta property="og:description" content="Learn web programming!">
    <meta property="og:image" content="favicon.png">
    <script src="CanvasInput.js"></script>
    <script>
        window.requestAnimFrame = (function(){
            // Glue code found on stackoverflow :)
            return window.requestAnimationFrame       
                || window.webkitRequestAnimationFrame 
                || window.mozRequestAnimationFrame    
                || ((callback) => window.setTimeout(callback, 1000 / 60));
        })();
      
        window.onload = () => {
            let theCanvas = document.getElementById("ui-canvas");

            var htmlInput = "<title>input</title>";
    
            function fitToContainer(canvas){
                // Make it visually fill the positioned parent
                canvas.style.width ='100%';
                canvas.style.height='100%';
                // ...then set the internal size to match
                canvas.width  = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
            }

            let thePreview = document.getElementById("preview");
            let theHTML = document.getElementById("html");

            // Tracking mouse position. We can use mouse.x and mouse.y to get
            // mouse coordinates within to the canvas.
            let mouse = { x: 0, y: 0 };
            theCanvas.onmousemove = (e) => {
                mouse.x = e.offsetX;
                mouse.y = e.offsetY;
            };
            function isMouseIn(x, y, w, h) {
                return mouse.x >= x && mouse.y >= y 
                    && mouse.x <= x + w && mouse.y <= y + h;
            }

            let tags = [];
            let elements = [];

            class Tag {
                constructor(tag, color, hasInput = true, tagclass = Element) {
                    this.tag = tag;
                    this.tagclass = tagclass;
                    this.color = color;
                    this.hasInput = hasInput;
                }

                hovered(i) {
                    let x = 8;
                    let y = i * 48 + 8;
                    return mouse.x >= x && mouse.y >= y && mouse.x <= x + 80 && mouse.y <= y + 40;
                }

                click(i, canvas) {
                    let x = 8;
                    let y = i * 48 + 8;
                    if (this.hovered(i)) {
                        elements.push(new this.tagclass(this, canvas, 240, 120));
                    }
                }

                draw(i, ctx) {
                    // Compute position for ith button.
                    let x = 8;
                    let y = i * 48 + 8;

                    // Draw button background.
                    ctx.fillStyle = this.color;
                    let hovering = this.hovered(i);
                    ctx.fillRect(hovering ? x - 2 : x, hovering ? y - 2 : y, hovering ? 84 : 80, hovering ? 44 : 40);
                    
                    // Draw button label.
                    ctx.font = "12pt Montserrat";
                    ctx.fillStyle = "white";
                    ctx.fillText(`<${this.tag}>`, x + 8, y + 24);
                }
            }

            class Element {
                constructor(button, canvas, w, h) {
                    this.button = button;
                    this.w = w;
                    this.h = h;
                    this.input = new CanvasInput({
                        canvas: canvas,
                        width: w - 28,
                        height: 24,
                        borderRadius: 0,
                        borderColor: "white",
                        boxShadow: "0px 0px 0px 0px",
                        innerShadow: "0px 0px 0px 0px"
                    });
                }

                height() {
                    return 56 + this.input.height();
                }

                draw(x, y, ctx) {
                    ctx.fillStyle = this.button.color;
                    ctx.fillRect(x, y, this.w, this.height());
                    this.input._x = x + 8;
                    this.input._y = y + 28;
                    this.input.render(ctx);
                    ctx.font = "10pt Montserrat";
                    ctx.fillStyle = "white";
                    ctx.fillText(`<${this.button.tag}>`, x + 8, y + 19);
                    ctx.font = "10pt Montserrat";
                    ctx.fillStyle = "white";
                    ctx.fillText(`</${this.button.tag}>`, x + 8, y + 47 + this.input.height());
                }

                html() {
                    return `<${this.button.tag}>${this.input.value()}</${this.button.tag}>`;
                }
            }

            class Link extends Element {
                html() {
                    return `<p><${this.button.tag} href=\"${this.input.value()}\">${this.input.value()}</${this.button.tag}></p>`;
                }
            }

            class Image extends Element {
                html() {
                    return `<${this.button.tag} src=${this.input.value()}>`;
                }
            }

            { // init
                tags.push(new Tag("h1", "blue"));
                tags.push(new Tag("p", "green"));
                tags.push(new Tag("a", "magenta", true, Link));
                tags.push(new Tag("img", "red", true, Image));
            };

            function render(ctx) {
                // Example render behavior. We'll want to replace the button rendering
                // with something more sophisticated in the future.
                fitToContainer(theCanvas);
                
                // Clear canvas to start a new frame.
                ctx.clearRect(0, 0, ctx.width, ctx.height);

                // Draw tag buttons.
                for (let i = 0; i < tags.length; i ++) {
                    tags[i].draw(i, ctx);
                }

                ctx.fillStyle = "black";
                ctx.fillRect(96, 0, 2, 400);

                // Draw elements.
                let x = 108;
                let y = 8;
                for (let i = 0; i < elements.length; i ++) {
                    elements[i].draw(x, y, ctx);
                    y += elements[i].height() + 8;
                }
            }

            theCanvas.onclick = (e) => {
                // Attempt click for every tag button.
                for (let i = 0; i < tags.length; i ++) {
                    tags[i].click(i, theCanvas);
                }
            }

            let downloadTab = document.getElementById("download-tab");
            downloadTab.onclick = (e) => {
                var html = thePreview.innerHTML;
                var link = document.createElement('a');
                var fileName = 'pandaCode.html';

                link.setAttribute('download', fileName);
                link.setAttribute('href', 'data:text/plain;charset=utf-8, ' + encodeURIComponent(html));
                link.click();
            }
            let previewTab = document.getElementById("preview-tab");
            // const fs = require('fs');
            previewTab.onclick = (e) => {
                // fs.writeFile('input.html', htmlInput, (err) => {
                //     if(err) throw err;
                // });

                let html = document.getElementById('html');
                let preview = document.getElementById('preview');

                if (html.style.display == 'block') {
                    html.style.display = 'none'
                    preview.style.display = 'block'
                }
            }
            let htmlTab = document.getElementById("html-tab");
            htmlTab.onclick = (e) => {
                let html = document.getElementById('html');
                let preview = document.getElementById('preview');

                if (preview.style.display == 'block') {
                    preview.style.display = 'none'
                    html.style.display = 'block'
                }
            }
            
            (function renderFrame() {
                requestAnimationFrame(renderFrame);
                render(theCanvas.getContext("2d"));
            })();

            function escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            function updatePreview() {
                let preview = "", html = "";
                for (let element of elements) {
                    let encoded = element.html();
                    preview += encoded;
                    html += escapeHtml(encoded);
                }
                thePreview.innerHTML = preview;
                theHTML.innerHTML = html;
            }

            setInterval(updatePreview, 1000);
        }
    </script>
</head>
<body>
    <div>
        <div style="display: inline-block; vertical-align: middle;">
            <img src="favicon.png" width="96px" height="96px">
        </div>  
        <div style="display: inline-block; vertical-align: middle;">
            <h1> Panda<span class="code-title">Code</span> </h1>
        </div>
    </div>
    <div class="panels">
        <div class="panel" id="layout-panel">
            <span class="panel-title">Layout</span><br>
            <canvas id="ui-canvas">
                <!-- Our GUI will be implemented in this canvas element. -->
            </canvas>
        </div><div class="panel" id="display-panel">
            <span class="panel-title">Display</span>
            <span class="panel-tab" id="download-tab">Download</span>
            <span class="panel-tab" id="preview-tab">Preview</span>
            <span class="panel-tab" id="html-tab">HTML</span><br>
            <div class="html-display">
                <div class="scrollbox">
                    <div class="display-body" id="preview" style="display: block">
                        <!-- 
                            Whatever site preview we want should
                            go in the innerHtml of this div. 
                        -->
                    </div>
                    <div class="display-body" id="html" style="display: none"></div>
                        <!-- 
                            Whatever code display we want should
                            go in the innerHtml of this div. 
                        -->
                </div>
            </div>
        </div>
    </div>
</body>